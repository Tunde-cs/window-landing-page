{% extends "base/adminbase.html" %}
{% load static %}

{% block head %}
    <title>Admin Dashboard | Window Replacement</title>
   
    <!-- ✅ Load Styles -->
    <link rel="stylesheet" href="{% static 'admin/dist/css/adminlte.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/custom.css' %}">
{% endblock %}

{% block content %}

<!-- ✅ Page Header -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Welcome, {{ user.get_full_name|default:user.username }}!</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="{% url 'useradmin' %}">Home</a></li>
                    <li class="breadcrumb-item active">Dashboard</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- ✅ User Profile Section -->
<div class="card mb-4 shadow-sm">
    <div class="card-body text-center">
        <h4 class="mb-2">{{ request.user.get_full_name|default:request.user.username }}</h4>
        <p class="text-muted">
            Role: {% if request.user.profile and request.user.profile.role %} 
                      {{ request.user.profile.role }} 
                  {% else %} Employee {% endif %}
        </p>
        <p>Last login: {{ request.user.last_login|date:"M d, Y H:i A" }}</p>
        
        <!-- ✅ Profile Picture (Use Dynamic Image if Available) -->
        {% if request.user.profile and request.user.profile.image %}
            <img src="{{ request.user.profile.image.url }}" 
                 alt="Profile Picture"
                 class="img-thumbnail mt-2" width="120">
        {% else %}
            <img src="{% static 'assets/img/default-profile.png' %}" 
                 onerror="this.onerror=null;this.src='https://via.placeholder.com/120';" 
                 alt="Profile Picture" class="img-thumbnail mt-2" width="120">
        {% endif %}
    </div>
</div>

<!-- ✅ Main Content -->
<section class="content">
    <div class="container-fluid">
        
        <!-- ✅ Key Metrics -->
        <div class="row">
            <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                <a href="{% url 'adminleads' %}">
                    <div class="card bg-info text-white shadow">
                        <div class="card-body text-center">
                            <h4><i class="fas fa-user-plus"></i> New Leads</h4>
                            <h3>{{ metrics.new_leads_count }}</h3>
                        </div>
                    </div>
                </a>
            </div>

            <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                <a href="{% url 'inbox' %}">
                    <div class="card bg-primary text-white shadow">
                        <div class="card-body text-center">
                            <h4><i class="fas fa-envelope"></i> Inbox</h4>
                            <h3>{{ metrics.message_count }}</h3>
                        </div>
                    </div>
                </a>
            </div>

            <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                <a href="{% url 'pending_orders' %}">
                    <div class="card bg-warning text-white shadow">
                        <div class="card-body text-center">
                            <h4><i class="fas fa-shopping-cart"></i> Pending Orders</h4>
                            <h3>{{ metrics.pending_orders_count }}</h3>
                        </div>
                    </div>
                </a>
            </div>

            <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
                <a href="{% url 'projects' %}">
                    <div class="card bg-success text-white shadow">
                        <div class="card-body text-center">
                            <h4><i class="fas fa-check-circle"></i> Completed Projects</h4>
                            <h3>{{ metrics.completed_projects_count }}</h3>
                        </div>
                    </div>
                </a>
            </div>
        </div>

        <!-- ✅ Monthly Revenue & Conversion Rate -->
<div class="row">
    <!-- ✅ Monthly Revenue Section (Clickable) -->
    <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
        <a href="{% url 'revenue' %}">
            <div class="card bg-primary text-white shadow">
                <div class="card-body text-center">
                    <h4><i class="fas fa-chart-line"></i> Monthly Revenue</h4>
                    <h3>${{ metrics.monthly_revenue|floatformat:2 }}</h3>
                </div>
            </div>
        </a>
    </div>

    <!-- ✅ Conversion Rate Section -->
    <div class="col-lg-3 col-md-6 col-sm-12 mb-4">
        <div class="card bg-secondary text-white shadow">
            <div class="card-body text-center">
                <h4><i class="fas fa-percentage"></i> Conversion Rate</h4>
                <h3>{{ metrics.conversion_rate }}%</h3>
            </div>
        </div>
    </div>
</div>

        
    <!-- ✅ Sales Overview Chart -->
<div class="card">
    <div class="card-header bg-dark text-white">
        <h3 class="card-title"><i class="fas fa-chart-bar"></i> Sales Overview</h3>
    </div>
    <div class="card-body">
        <!-- ✅ Ensure this ID Matches the JavaScript -->
        <canvas id="salesChart" style="width: 100%; height: 400px;"></canvas>
    </div>
</div>

<!-- ✅ Load Chart.js from CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // Get the canvas element for the sales chart
    const canvas = document.getElementById("salesChart");
    if (!canvas) return; // Exit if not found

    // Parse chart data passed from Django context
    const salesChartLabels = JSON.parse('{{ sales_chart_labels|safe }}');
    const salesChartData = JSON.parse('{{ sales_chart_data|safe }}');

    // Check if a chart instance already exists, and if so, destroy it to prevent duplicates
    if (window.salesChartInstance) {
        window.salesChartInstance.destroy();
    }

    // Create a new chart instance and store it globally
    window.salesChartInstance = new Chart(canvas.getContext("2d"), {
        type: "bar", // Using a bar chart; you can mix types if needed
        data: {
            labels: salesChartLabels,
            datasets: [{
                label: "Monthly Sales",
                data: salesChartData,
                backgroundColor: "rgba(75, 192, 192, 0.5)",
                borderColor: "rgba(75, 192, 192, 1)",
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    suggestedMax: Math.max(...salesChartData) * 1.2
                }
            }
        }
    });
});
</script>
{% endblock %}



